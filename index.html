<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>QR Master Pro</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assests/image/logo.png">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        #reader {
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #000;
        }

        #reader video {
            object-fit: cover;
            border-radius: 0.75rem;
        }

        .scan-region-highlight {
            border-radius: 10px;
            outline: 2px solid #3b82f6 !important;
        }

        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .tab-content.active {
            display: flex;
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .pt-safe-header {
            padding-top: calc(env(safe-area-inset-top) + 1.5rem) !important;
        }

        /* Flashlight Button Styling */
        .torch-btn {
            opacity: 0.3;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .torch-btn:hover,
        .torch-btn.active {
            opacity: 0.9;
            transform: scale(1.1);
        }

        .torch-btn.active {
            background-color: #fbbf24;
            /* yellow-400 */
            color: #000;
        }

        .shadow-up {
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>

<body class="bg-gray-100 text-slate-800 font-sans h-[100dvh] w-full overflow-hidden flex justify-center items-center">

    <!-- Mobile App Container -->
    <div
        class="w-full h-full max-h-[100dvh] sm:max-h-[850px] sm:w-[400px] sm:rounded-3xl bg-white shadow-2xl flex flex-col relative overflow-hidden border-gray-200 sm:border">

        <!-- Header -->
        <header
            class="flex-shrink-0 bg-blue-600 text-white p-4 pt-safe-header shadow-md z-20 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight flex items-center gap-2">
                    <img src="assests/image/logo.png" alt="Logo" class="w-8 h-8 object-contain"> QR Master
                </h1>
            </div>
            <button onclick="clearHistory()"
                class="text-xs font-semibold bg-blue-500 hover:bg-blue-700 px-3 py-1.5 rounded-full transition-colors">
                Clear History
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto relative bg-slate-50 w-full">

            <!-- VIEW: SCANNER -->
            <div id="view-scan" class="tab-content active flex-col h-full p-4">

                <!-- Camera Section -->
                <div class="flex-none flex flex-col items-center justify-center relative">
                    <div id="reader-container"
                        class="w-full aspect-square bg-gray-900 rounded-2xl overflow-hidden shadow-2xl flex items-center justify-center relative group">
                        <div id="reader" class="w-full h-full"></div>

                        <!-- Flashlight Toggle (Centered) -->
                        <button id="btn-torch"
                            class="torch-btn hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 w-16 h-16 bg-black/40 text-white rounded-full flex items-center justify-center shadow-lg border border-white/20">
                            <i data-lucide="zap" class="w-8 h-8"></i>
                        </button>

                        <div id="camera-placeholder"
                            class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-0">
                            <i data-lucide="camera" class="w-12 h-12 mb-2 opacity-20"></i>
                            <span class="text-sm font-medium opacity-40">Camera Ready</span>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3 w-full">
                        <button id="btn-start-scan"
                            class="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3">
                            <i data-lucide="play" class="w-5 h-5"></i> Start Scanner
                        </button>
                        <button id="btn-stop-scan"
                            class="hidden flex-1 py-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3">
                            <i data-lucide="square" class="w-5 h-5"></i> Stop
                        </button>
                    </div>
                </div>

                <!-- History Container -->
                <div id="scan-history" class="w-full flex flex-col gap-3 mt-6 pb-6">
                    <div id="empty-history-msg" class="text-center py-10">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="history" class="w-8 h-8 text-gray-300"></i>
                        </div>
                        <p class="text-gray-400 text-sm">No scans in this session</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: GENERATOR -->
            <div id="view-generate" class="tab-content flex-col p-4 h-full">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3">Data
                        Input</label>
                    <textarea id="gen-input" rows="2" placeholder="Enter URL, text, or phone number..."
                        class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-all resize-none"></textarea>

                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="setType('qr')" id="btn-type-qr"
                            class="type-btn active py-3 rounded-xl text-sm font-bold border-2 border-blue-600 bg-blue-50 text-blue-700 transition-all">
                            QR Code
                        </button>
                        <button onclick="setType('barcode')" id="btn-type-bar"
                            class="type-btn py-3 rounded-xl text-sm font-bold border-2 border-gray-100 text-gray-500 hover:bg-gray-50 transition-all">
                            Barcode
                        </button>
                    </div>
                </div>

                <!-- Preview Area -->
                <div
                    class="flex-1 flex flex-col items-center justify-center bg-white rounded-2xl shadow-sm border border-gray-100 p-8 min-h-[250px] relative">
                    <div id="preview-area" class="w-full h-full flex items-center justify-center">
                        <div id="qrcode-container" class="hidden"></div>
                        <canvas id="barcode-canvas" class="hidden max-w-full"></canvas>

                        <div id="gen-placeholder" class="text-center text-gray-300">
                            <i data-lucide="sparkles" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                            <p class="text-sm font-medium">Ready to generate</p>
                        </div>
                    </div>
                </div>

                <button onclick="downloadCode()" id="btn-download" disabled
                    class="mt-6 w-full py-4 bg-blue-600 disabled:bg-gray-200 disabled:text-gray-400 hover:bg-blue-700 text-white rounded-xl font-bold shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i data-lucide="download" class="w-5 h-5"></i> Save to Gallery
                </button>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="flex-shrink-0 bg-white border-t border-gray-100 flex justify-around p-3 pb-safe z-20 shadow-up">
            <button onclick="switchTab('scan')" id="nav-scan"
                class="nav-item active flex-1 flex flex-col items-center py-2 rounded-2xl text-blue-600 transition-all">
                <i data-lucide="scan" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Scanner</span>
            </button>
            <button onclick="switchTab('generate')" id="nav-generate"
                class="nav-item flex-1 flex flex-col items-center py-2 rounded-2xl text-gray-300 hover:text-gray-500 transition-all">
                <i data-lucide="plus-square" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Create</span>
            </button>
        </nav>

        <!-- Toast -->
        <div id="toast"
            class="absolute bottom-24 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-2xl opacity-0 pointer-events-none transition-all duration-300 flex items-center gap-3 z-50">
            <i data-lucide="check" class="w-4 h-4 text-green-400"></i>
            <span id="toast-msg">Success!</span>
        </div>

    </div>

    <script>
        /**
         * 1. Create a separate file named 'sw.js' in your root directory.
         * 2. Host the app via HTTPS.
         * 3. Browsers block Service Workers registered from 'blob:' URLs for security.
         */

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // --- Initialization ---
        lucide.createIcons();

        let html5QrCode;
        let currentType = 'qr';
        let lastScannedText = null;
        let lastScannedTime = 0;
        let torchEnabled = false;

        // --- Tabs ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-blue-600');
                el.classList.add('text-gray-300');
            });
            document.getElementById(`nav-${tab}`).classList.remove('text-gray-300');
            document.getElementById(`nav-${tab}`).classList.add('text-blue-600');

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');

            if (tab === 'generate' && html5QrCode && html5QrCode.isScanning) {
                stopScanning();
            }
        }

        // --- Scanner Logic ---
        const btnStart = document.getElementById('btn-start-scan');
        const btnStop = document.getElementById('btn-stop-scan');
        const btnTorch = document.getElementById('btn-torch');

        btnStart.addEventListener('click', startScanning);
        btnStop.addEventListener('click', stopScanning);
        btnTorch.addEventListener('click', toggleTorch);

        async function startScanning() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            const config = {
                fps: 15,
                qrbox: { width: 220, height: 220 },
                aspectRatio: 1.0
            };

            try {
                await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);

                document.getElementById('camera-placeholder').classList.add('hidden');
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');

                // Check for torch capability after start
                setTimeout(() => {
                    try {
                        const tracks = html5QrCode.getRunningTrackCapabilities();
                        if (tracks && tracks.torch) {
                            btnTorch.classList.remove('hidden');
                        }
                    } catch (e) { console.warn("Track capabilities not available"); }
                }, 1000);

            } catch (err) {
                showToast("Camera Access Error: Check permissions");
                console.error(err);
            }
        }

        async function stopScanning() {
            if (html5QrCode) {
                try {
                    if (torchEnabled) await toggleTorch();
                    await html5QrCode.stop();
                    document.getElementById('camera-placeholder').classList.remove('hidden');
                    btnStart.classList.remove('hidden');
                    btnStop.classList.add('hidden');
                    btnTorch.classList.add('hidden');
                } catch (err) {
                    console.error(err);
                }
            }
        }

        async function toggleTorch() {
            if (!html5QrCode || !html5QrCode.isScanning) return;

            torchEnabled = !torchEnabled;
            try {
                await html5QrCode.applyVideoConstraints({
                    advanced: [{ torch: torchEnabled }]
                });

                if (torchEnabled) {
                    btnTorch.classList.add('active');
                    btnTorch.innerHTML = `<i data-lucide="zap-off" class="w-8 h-8"></i>`;
                } else {
                    btnTorch.classList.remove('active');
                    btnTorch.innerHTML = `<i data-lucide="zap" class="w-8 h-8"></i>`;
                }
                lucide.createIcons();
            } catch (err) {
                console.error("Torch not supported", err);
                btnTorch.classList.add('hidden');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            const currentTime = Date.now();
            if (decodedText === lastScannedText && (currentTime - lastScannedTime < 3000)) return;

            lastScannedText = decodedText;
            lastScannedTime = currentTime;

            const formatName = decodedResult?.result?.format?.formatName || "CODE";
            addResultToHistory(decodedText, formatName);

            if (navigator.vibrate) navigator.vibrate(100);
            showToast("Scanned Successfully");
        }

        function onScanFailure(error) { /* Silent */ }

        function addResultToHistory(text, format) {
            const container = document.getElementById('scan-history');
            const emptyMsg = document.getElementById('empty-history-msg');
            if (emptyMsg) emptyMsg.remove();

            const item = document.createElement('div');
            item.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-bottom-4 duration-300";

            const isUrl = /^(http|https):\/\/[^ "]+$/.test(text);
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            item.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[9px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded-md uppercase tracking-wider">${format}</span>
                    <span class="text-[10px] text-gray-400 font-bold">${time}</span>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4">
                    <p class="text-xs font-mono text-gray-700 break-all leading-relaxed">${text}</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn-copy flex-1 bg-gray-900 text-white py-2.5 rounded-xl text-xs font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> Copy
                    </button>
                    ${isUrl ? `
                    <a href="${text}" target="_blank" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl text-xs font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="external-link" class="w-3.5 h-3.5"></i> Open
                    </a>` : ''}
                </div>
            `;

            item.querySelector('.btn-copy').onclick = () => copyToClipboard(text);
            container.prepend(item);
            lucide.createIcons();
        }

        // --- Generator Logic ---
        const inputEl = document.getElementById('gen-input');
        const qrContainer = document.getElementById('qrcode-container');
        const barcodeCanvas = document.getElementById('barcode-canvas');
        const placeholder = document.getElementById('gen-placeholder');
        const btnDownload = document.getElementById('btn-download');

        let genTimeout;
        inputEl.addEventListener('input', () => {
            clearTimeout(genTimeout);
            genTimeout = setTimeout(generateCode, 400);
        });

        function setType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'bg-blue-50', 'text-blue-700', 'active');
                btn.classList.add('border-gray-100', 'text-gray-500');
            });
            const activeBtn = type === 'qr' ? document.getElementById('btn-type-qr') : document.getElementById('btn-type-bar');
            activeBtn.classList.add('border-blue-600', 'bg-blue-50', 'text-blue-700', 'active');
            activeBtn.classList.remove('border-gray-100', 'text-gray-500');
            generateCode();
        }

        function generateCode() {
            const text = inputEl.value.trim();
            qrContainer.innerHTML = '';
            qrContainer.classList.add('hidden');
            barcodeCanvas.classList.add('hidden');
            placeholder.classList.add('hidden');
            btnDownload.disabled = true;

            if (!text) {
                placeholder.classList.remove('hidden');
                return;
            }

            if (currentType === 'qr') {
                qrContainer.classList.remove('hidden');
                new QRCode(qrContainer, {
                    text: text,
                    width: 240,
                    height: 240,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                setTimeout(() => { btnDownload.disabled = false; }, 200);
            } else {
                barcodeCanvas.classList.remove('hidden');
                try {
                    JsBarcode("#barcode-canvas", text, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2,
                        height: 80,
                        displayValue: true
                    });
                    btnDownload.disabled = false;
                } catch (e) {
                    showToast("Barcode Format Error");
                }
            }
        }

        function downloadCode() {
            let canvas = currentType === 'qr' ? qrContainer.querySelector('canvas') : barcodeCanvas;
            let img = qrContainer.querySelector('img');

            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            const padding = 40;

            if (canvas || img) {
                const w = canvas ? canvas.width : img.naturalWidth;
                const h = canvas ? canvas.height : img.naturalHeight;
                tempCanvas.width = w + padding;
                tempCanvas.height = h + padding;
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                if (canvas) ctx.drawImage(canvas, padding / 2, padding / 2);
                else ctx.drawImage(img, padding / 2, padding / 2);

                const link = document.createElement('a');
                link.download = `QR-Master-${Date.now()}.png`;
                link.href = tempCanvas.toDataURL("image/png");
                link.click();
                showToast("Saved Successfully");
            }
        }

        // --- Utils ---
        function clearHistory() {
            document.getElementById('scan-history').innerHTML = `
                <div id="empty-history-msg" class="text-center py-10">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="history" class="w-8 h-8 text-gray-300"></i>
                    </div>
                    <p class="text-gray-400 text-sm">History cleared</p>
                </div>
            `;
            lucide.createIcons();
            lastScannedText = null;
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Copied to Clipboard");
            } catch (err) {
                showToast("Failed to copy");
            }
            document.body.removeChild(textArea);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
            }, 2500);
        }
    </script>
</body>

</html>